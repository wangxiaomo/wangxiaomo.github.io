
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>小默的研究中心</title>
  <meta name="author" content="wangxiaomo">

  
  <meta name="description" content="刚才折腾了半天hg,我去,记得当初也没那么难搞啊..code google上面的代码控制不会弄了.害我直接转到bitbucker了.继续说 curl的问题.搞完这个还要看 perl大会视频呢.
首先.php 编程不会curl就是坑爹呢/所以, 这个必须会.
通过几个简单的例子说明问题,以后有需求, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://wangxiaomo.github.com/blog/page/9/">
  <link href="/oct/favicon.png" rel="icon">
  <link href="/oct/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/oct/javascripts/modernizr-2.0.js"></script>
  <script src="/oct/javascripts/ender.js"></script>
  <script src="/oct/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/oct/blog/atom.xml" rel="alternate" title="小默的研究中心" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/oct/">小默的研究中心</a></h1>
  
    <h2>Perl | PHP | Python...技术宅.微博控</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/oct/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:wangxiaomo.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/oct/">Blog</a></li>
  <li><a href="/oct/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/oct/blog/2011/07/04/PHP+curl%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B./">PHP Curl使用示例.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-04T05:52:00+08:00" pubdate data-updated="true">Jul 4<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>刚才折腾了半天hg,我去,记得当初也没那么难搞啊..code google上面的代码控制不会弄了.害我直接转到bitbucker了.继续说 curl的问题.搞完这个还要看 perl大会视频呢.
首先.php 编程不会curl就是坑爹呢/所以, 这个必须会.
通过几个简单的例子说明问题,以后有需求,再研究.
1.获取页面源码.</p>

<pre lang="php">
<?php
$url = "http://www.baidu.com";
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
$result = curl_exec($ch);
curl_close($ch);

var_dump($result);
?>
</pre>


<p>如果不设置CURLOPT_RETURNTRANSFER的话,html会自动返回输出,通过这一选项,可以把输出保存到变量中去.
2.POST数据.</p>

<pre lang="php">
<?php
$url = "http://api.t.sina.com.cn/oauth/authorize?oauth_token=c61f2bd0e7c4246d12c764eba0d49450";
$ch = curl_init();
$param = "userId=".urlencode("xxx")."&password=".urlencode("xxx");
curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); 
curl_setopt($ch, CURLOPT_POST, 1); 
curl_setopt($ch, CURLOPT_POSTFIELDS, $param);
$result = curl_exec($ch);
curl_close($ch);
print $result;
?>
</pre>


<p>post的数据有两者哦你,一种是:</p>

<pre lang="php">
<?php
$param = array(
    "username" => "xxx",
    "password"  => "xxx"
);
?>
</pre>


<p>另一种是.</p>

<pre lang="php">
<?php
$param = "username=xxx&password=xxx";
?>
</pre>


<p>一般的表单用第二种,除非form中明确指出multipart/form-data,否则用第二种.两种默认的编码方式不同..
3.在header中传递参数.</p>

<pre lang="php">
<?php
$header = array(
    'Content-Type: application/atom+xml',
    $acc_req->to_header()
);

$ch = curl_init();
curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
curl_setopt($ch, CURLOPT_HEADER, 1);
curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
$result = curl_exec($ch);
curl_close($ch);
?>
</pre>


<p>That&#8217;s all</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/oct/blog/2011/07/04/Python+mechanize%E8%AE%B2%E8%A7%A3./">Python Mechanize讲解.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-04T02:48:00+08:00" pubdate data-updated="true">Jul 4<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>第一次接触到mechanize是ruby,用mechanize写了个扫描校园网络帐号的代码.初步感受到了mechanize的强大,之后又在 CPAN看到mechanize的身影. 最近写oauth自动获取pin时,索性就用起了它,不过跟gem/mechanize,WWW::Mechanize还是有些许的差别的&#8230;
首先,需要下载mechanize,这个不多说了.直接从应用说起.</p>

<pre lang="python">
from mechanize import Browser
br = Browser()
br.set_handle_equiv(False)
br.set_handle_robots(False)
</pre>


<p>上面代码就是基本的准备步骤.两个set是用来跳过robots.有些网站有robots规则,所以不能实现模拟访问.
然后就是通过open等方法来执行进一步的操作.</p>

<pre lang="python">
br.open("http://ghtt.net")   #打开url
br.title()                              #得到当前页面的title.
br.back(n)                           #后退n步,默认n为1.
br.select_form(name="")   #设定当前的表单
br['username'] = 'xza'       #填写表单
br.submit()                          #提交表单.
br.response()                       #得到响应,可通过read或者 readlines进行下一步操作
</pre>


<p>以上就是常用的一些方法.
有一个需要注意的就是 click_link和follow_link.他们的默认参数形式是link类型的,link类型的我不知道怎么实例构造,只知道能从find_link中得到,所以我们可以通过find_link通过regex来定位到url.然后 follow_link.
还有一种方式就是通过follow_link(text=&#8221;Click&#8221;)通过超链接中的文字来进行定位.
最后一个需要注意的就是,click_link只是单纯的点击,所以想要进行下一步操作的话,最好使用follow_link.
具体的根据情况help(mechanize)去.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/oct/blog/2011/07/04/Python+%E8%87%AA%E5%8A%A8%E8%8E%B7%E5%8F%96OAuth+PIN%E7%A0%81/">Python 自动获取OAuth PIN码</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-04T01:59:00+08:00" pubdate data-updated="true">Jul 4<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>OAuth认证在客户端应用时没有callback,需要引导用户到指定页面进行认证,然后回到客户端输入PIN,就是verifier.这个过程很繁琐,很不友好..sina有XAuth,但是咱申请不到,所以咱还是自己实现吧&#8230;</p>

<pre lang="python">
#!/usr/bin/python 
#-*- coding: utf-8 -*-

#--------------------------------------
from mechanize import Browser
import re
import sys
"""
construct:
    @Param url : auth_url
    @Param username : username
    @Param password : password
    @Return Object
"""
class GetPIN():
    def __init__(self,url,username, password):
        self.br = Browser()
        self.br.set_handle_equiv(False)
        self.br.set_handle_robots(False)
        self.url = url
        self.username = username
        self.password = password
    
    def getPIN(self):
        self.br.open(self.url)
        try:
            self.br.select_form(name="authZForm")
            self.br['userId'] = self.username
            self.br['passwd'] = self.password
            response = self.br.submit()
            data = response.readlines()
        except:
            data = self.br.response().readlines()
        pattern = r'<span class="fb">(.*?)</span>' 
        pat = re.compile(pattern)
        for line in data:
            if pat.search(line):
                verifier = pat.findall(line)
                break
        if len(verifier):
            return verifier[0]
        else:
            return -1

if __name__ == "__main__":
    print "This is a Module"
    sys.exit(-1)
</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/oct/blog/2011/07/03/%E8%AF%BBphp+OAuth%E4%BB%A3%E7%A0%81%E5%BF%83%E5%BE%97/">读php OAuth代码心得</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-03T08:38:00+08:00" pubdate data-updated="true">Jul 3<span>rd</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>准备假期做sns同步,当然是要挂在sae上,所以趁早看看php oauth的代码吧.虽然oauth的基本过程还是了解的,但是不同的sdk实现不同,理解起来还是存在误区的..
这个文章就对python sdk和php sdk进行分析对比吧..
两者不借助任何sns厂商的sdk,只是依靠基本的oauth sdk进行实现时,基本的过程就是:</p>

<pre lang="bash">
1.根据app_key,app_secret获得授权的request_token和request_token_secret
2.根据request_token中的公钥构造auth_url.跳转让用户进行认证.
3.根据app_key,app_secret,request_token,request_token_secret来获得access_token和access_token_secret
(无callback的时候,通过附加pin参数,来获得access_token,豆瓣的oauth不需要.
</pre>


<p>然后就是具体的实现了.
其实标准的实现就是.用php来说.</p>

<pre lang="php">
//全局配置.
$request_url = xxx;
$auth_url = xxx;
$access_url = xxx;
$app_key = xxx;
$app_secret = xxx;
$hmac_method = new OAuthSignatureMethod_HMAC_SHA1();
$sig_method = $hmac_method;

//Step1.
//定义应用consumer
$app_consumer = new OAuthConsumer($app_key, $app_secret);
$req_req = OAuthRequest::from_consumer_and_token($app_consumer,
 NULL, "GET", $request_url);
//签名补全数据
$req_req->sign_request($sig_method, $app_consumer, NULL);
//构造好数据信息,然后通过to_url获得url,或者通过to_header获得头部信息.
//通过 curl访问.
$ch = curl_init();
curlsetopt($ch, CURLOPT_URL, $req_req->to_url());
curlsetopt($ch, CURLOPT_RETURNTRANSFER, 1);
$result = curl_exec($ch);
curl_close($ch);
//$result形如oauth_token_secret=xxx&oauth_token=xxx格式.
parse_str($result, $arr);
//获得request_token
$request_token = $arr['oauth_token'];
$request_token_secret = $arr['oauth_token_secret'];

//Step2.
//构造认证url.
$auth_url = $auth_url . "?oauth_token=" . $request_token . "&callback=NULL";
echo "认证: " . $auth_url . "\n";
echo "认证完毕?\n";
$pin = fread(STDIN, 80);
//如果是 callback的认证方式的话,跳过接收pin过程,直接进行 Step3

//Step3.
//构造$request_consumer
$request_consumer = new OAuthConsumer($request_token, $request_token_secret);
$acc_req = OAuthRequest::from_consumer_and_token($app_consumer, $request_consumer, "GET", $access_url);
//如果是通过pin的认证.
//$acc_req = OAuthRequest::from_consumer_and_token($app_consumer, $request_consumer, "GET", $access_url, 
//array('oauth_verifier'=>intval($pin)));
//签名补全数据.
$acc_req->sign_request($sig_method, $app_consumer, $request_consumer);
//curl访问.
//....
//获得access_token,access_token_secret
?>
</pre>


<p>这就是基本的过程,第三步获得access_token的时候,官方sdk上写的是post获取,但是我通过get都能获取到,额.这个,解释不同,先不管了..
然后就说下python里面的请求.
python用到的OAuth库是OAuth2.
里面过程中用到了oauth.client.这个嘛,相当于就是构造好参数,然后通过request方法访问的一个虚拟的client.类似于php中的构造数据和curl部分.当然,oauth2也可以用类似php的方式进行oauth认证..</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/oct/blog/2011/07/01/%E4%BB%8B%E4%B8%AA%E6%89%8D%E6%98%AF%E7%9C%9F%E6%AD%A3%E7%9A%84OAuth.../">介个才是真正的OAuth&#8230;</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-01T20:31:00+08:00" pubdate data-updated="true">Jul 1<span>st</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>新浪,人人,豆瓣的OAuth SDK Samples形式各式各样,搞得我都混乱了.要不是最后看了oauth的标准代码,我都以为oauth过程是他们自己写的呢&#8230;
汗.所以说,不能完全信sdk.sdk省略的流程不一样,所以理解起来也不一样..
下面是标准的步骤..</p>

<pre lang="python">
import urlparse
import oauth2 as oauth

APP_KEY = "044c0365545f5efc0ce40a2ffd1e1cf4"
APP_SECRET = "ba067c5a136fb25d"
request_url = "http://www.douban.com/service/auth/request_token"
auth_url = "http://www.douban.com/service/auth/authorize"
access_url = "http://www.douban.com/service/auth/access_token"

###STEP1
consumer = oauth.Consumer(APP_KEY, APP_SECRET)
client = oauth.Client(consumer)

resp, content = client.request(request_url, "GET")
if resp['status'] != '200':
    raise Exception("Invalid response %s" % resp['status'])
request_token = dict(urlparse.parse_qsl(content))

###STEP2
url = "%s?oauth_token=%s" % (auth_url, request_token['oauth_token'])
print url 
verifier = raw_input("PIN: ").strip()

###STEP3
token = oauth.Token(request_token['oauth_token'], request_token['oauth_token_secret'])
#token.set_verifier(verifier)
client = oauth.Client(consumer, token)

resp, content = client.request(access_url, "POST")
access_token = dict(urlparse.parse_qsl(content))

print access_token
</pre>


<p>参考网址.<a href="https://github.com/simplegeo/python-oauth2/blob/master/README.md">Click</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/oct/blog/2011/07/01/Python+urllib2%E7%9A%84%E5%87%A0%E4%B8%AA%E6%B3%A8%E6%84%8F%E7%82%B9./">Python Urllib2的几个注意点.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-01T18:25:00+08:00" pubdate data-updated="true">Jul 1<span>st</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>urllib2作为最常用的模块,有几点被我所忽视了&#8230;proxy,cookie什么的这里就不说了, 用到了再说..
1.urlencode.这几天在做url的编码时候,一直想不起来py用什么来encode.其实urllib2.quote就很容易的实现了urlencode</p>

<pre lang="python">
from urllib2 import quote as urlencode
print urlencode("http://www.baidu.com")
</pre>


<p>2.Request添加header. Oauth添加认证信息有三种方式,添加到header,get,post中.其中添加到header是被推荐的,所以get,post基本不予考虑&#8230;</p>

<pre lang="python">
from urllib2 import Request,urlopen

###添加auth_data
data = urlopen(Request(auth_url, headers={"Authorization":auth_data})) \
            .read()
</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/oct/blog/2011/07/01/Python+Sina+Oauth%E7%99%BB%E5%BD%95/">Python Sina Oauth登录</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-01T18:02:00+08:00" pubdate data-updated="true">Jul 1<span>st</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>刚才把sae的sdk hack掉了.竟然不是oauth认证,失望啊&#8230;算了,趁着这个机会把sina  weibo的oauth写了吧&#8230;
sina weibo有官方的python sdk.所以我们不需要重现oauth过程,也不需要调用python的oauth标准库.
标准Oauth登录.</p>

<pre lang="python">
#!/usr/bin/python 
#-*- coding: utf-8 -*-

#-------------------------------------------------------
#Var
#-------------------------------------------------------
###AppInfo
APP_KEY = "2986120742"
APP_SECRET = "796b90d5a6e3a1cc4d719726f5f99f7d"
#-------------------------------------------------------

from weibopy.auth import OAuthHandler
from weibopy.api import API

###获得应用的token
auth = OAuthHandler(APP_KEY, APP_SECRET)
###获得用户OAuth登录的url
auth_url = auth.get_authorization_url()
print "Please Auth: "+auth_url
verifier = raw_input("PIN: ").strip()
access_token = auth.get_access_token(verifier)
###获得access_token

###发布微博
api = API(auth)
status = api.update_status(status="Hello World")

###获得access_token后,以后便可以通过
###auth.set_access_token(access_token.key, access_token.secret)
###完成授权.
</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/oct/blog/2011/07/01/SAE+hack.+python+ver./">SAE Hack. Python Ver.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-01T14:49:00+08:00" pubdate data-updated="true">Jul 1<span>st</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>天气热,在寝室待着没事干,就研究了下SAE的am.php,之前一直觉得sae sdk的auth是oauth,` 研究完之后发现只是简单的GET传递.所以整体实现不是很复杂.而且sae sdk有些不稳定,有些情况下还是有点不方便的.所以把自己常用的功能hack下吧..
下面看代码..
getAppFromSAE.py</p>

<pre lang="python">
#!/usr/bin/python
#-*- coding: utf-8 -*-

#--------------------------------------------
# Var
#--------------------------------------------
_sae_url = "http://deploy.sae.sina.com.cn/"
_get_token_url_format = _sae_url+'?action=auth&email=%s&password=%s'
_get_app_url_format = _sae_url+'?action=download&name=%s&version=%s&' \
                              +'cookie=%s'
_get_applist_format = _sae_url+'?action=applist&email=%s&cookie=%s'

#-------------------------------------------
from urllib2 import urlopen
from urllib2 import quote as urlencode
import re
import json

import sys,os

class SAE:
    def __init__(self):
        self.email = ""
        self.token = ""
        self.appinfo = []
        if not re.match(r'linux|posix', sys.platform):
            print "Linux Only"
            sys.exit(-1)
        if os.path.exists("apps/.email") and os.path.exists("apps/.token"):
            with open("apps/.email", "r") as f:
                self.email = f.readline()
            with open("apps/.token", "r") as f:
                self.token = f.readline()
        else:
            self.readin()
    
    def _get_token(self, email, password):
        url = _get_token_url_format % (email, password)
        token = urlopen(url).read()
        if re.search(r'403', self.token):
            return -1
        return token

    def readin(self):
        email = raw_input("Input your Email:").strip()
        password = urlencode(raw_input("Input your password:")).strip()
        if not re.search(r'@', email):
            print "Email Format Error"
            sys.exit(-1)
        token = self._get_token(email, password)
        if token == -1:
            print "Account Error"
            sys.exit(-1)
        if not os.path.exists("apps"):
            os.mkdir("apps")
        with open("apps/.email", "w") as f:
            f.write(email)
        with open("apps/.token", "w") as f:
            f.write(token)
        print ""
    
    """DEBUG"""
    def show(self):
        print self.email,self.password,self.token

    def getAppList(self):
        if not self.email or not self.token:
            self.readin()
        url = _get_applist_format % (self.email, self.token)
        applist = urlopen(url).read()
        #DEBUG
        #print applist
        applist_ref = json.loads(applist)
        #print applist_ref
        keys = applist_ref['data'].keys()
        for key in keys:
            app = {}
            app['name'] = key
            # app的版本数
            app_count = len(applist_ref['data'][key]['versions'])
            version_keys = applist_ref['data'][key]['versions'].keys()
            app['versions'] = ','.join(version_keys)
            for version in version_keys:
                flag = applist_ref['data'][key]['versions'][version]['is_default']
                if flag:
                    app['default_version'] = version
                    app['last_deploy'] = applist_ref['data'][key]['versions'][version]['last_deploy']
                    break
            self.appinfo.append(app)

    def showAppList(self):
        if len(self.appinfo) == 0:
            self.getAppList()
        for app in self.appinfo:
            print "AppName:%s\nAppVersions:%s\nAppDefaultVersion:%s\nAppLastDeploy:%s\n" % (app['name'], \
                    app['versions'], app['default_version'], app['last_deploy'])
    
    def _checkApp(self, appname, appversion):
        if not len(self.appinfo):
            self.getAppList()
        for app in self.appinfo:
            if app['name'] == appname:
                versions = app['versions']
                if re.match(appversion, versions):
                    return True
        return False


    def getApp(self, appname, appversion):
        if not self._checkApp(appname, appversion):
            print "\nappname or appversion error"
            sys.exit(-2)
        url = _get_app_url_format % (appname, appversion, self.token)
        if not os.path.exists("apps"):
            os.mkdir("apps")
        data = urlopen(url).read()
        saving_file = "apps/%s.zip" % (appname+"_"+appversion)
        with open(saving_file, "w") as f:
            f.write(data)


#-----------------------------------------
if __name__ == '__main__':
    print "This is A Module"
</pre>


<p>main.py</p>

<pre lang="python">
#!/usr/bin/python 
#-*- coding: utf-8 -*-


#-------------------------------------------------------
from getAppFromSAE import SAE
def showapp():
    obj = SAE()
    obj.showAppList()

def update_user():
    obj = SAE()
    obj.readin()

def download(appname, appversion):
    obj = SAE()
    obj.getApp(appname, appversion)
#------------------------------------------------------

import optparse
import sys

if __name__ == "__main__":
    p = optparse.OptionParser()
    p.add_option("-u", "--update-user", action="store_true", dest="isUpdateUser", help="Update your Account Info")
    p.add_option("-s", "--showapp", action="store_true", dest="isShowapp", help="Show All your App Info")
    p.add_option("-d", "--download", action="store", dest="app", help="Download App From Internet Format:appname[,appversion]")

    opt,args = p.parse_args()
    #DEBUG
    #print opt

    if opt.isUpdateUser:
        update_user()

    if opt.isShowapp:
        showapp()

    if opt.app:
        try:
            appname,appversion = opt.app.split(',')
        except:
            print "Input Error"
            sys.exit(-1)
        #DEBUG
        #print appname, appversion
        download(appname, appversion)
</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/oct/blog/2011/06/27/Content+Provider%E8%AE%BE%E8%AE%A1./">Content Provider设计.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-27T06:51:00+08:00" pubdate data-updated="true">Jun 27<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Content Provide用来保存和检索数据,并使应用程序之间相互访问数据成为可能,它是跨应用程序共享数据的唯一方法.
Android为常用的数据类型提供了大量的Content Provider.他们被定义在android.provider包下面.通过定义好的Content Provider我们可以方便的进行数据操作.当然,我们必须拥有适当的权限.
ContentProvider定义在android.content包下面,我们定义一个ContentProvider必须实现几个抽象方法.</p>

<pre lang="bash">
query(Uri,String[],String,String[],String) 查询
insert(Uri,ContentValues) 插入
update(Uri,ContentValues,String,String[]) 更新
delete(Uri,String,String[]) 删除
getType(Uri) 获得MIME数据类型.
</pre>


<p>我们是在ContentProvider中实现我们实际操作数据的方法.但是在客户端调用时,我们用到了另外一个接口.它就是ContentResolver.ContentResolver提供和ContentProvider对应的方法.
ContentProvider是通过URI来实现共享的.一个URI对象必须以&#8221;content://&#8221;开头,接下来是URI的授权部分,这部分内容要和AndroidManifest.xml配置文件中声明的授权内容一致.后面还可能有数据类型和记录ID.
通过URI可以使ContentResolver知道和哪个ContentProvider对应,并且来操作哪些表和哪些记录.</p>

<pre lang="java">
private void query(){
     //获得ContentReslover实例.
     ContentResolver cr = getContentResolver();
     //定义Uri.
     Uri uri = Contacts.People.CONTENT_URI;
     //定义查询类数组.
     String[] projection = {Contacts.PeopleColumns.NAME,Contacts.PeopleColumns.NOTES};
     //定义查询条件.
     String selection = Contacts.PeopleColumns.NAME + "=?";
     //查询条件参数.
     String[] selectionArgs = {"Amaker"};
     String sortOrder = Contacts.PeopleColumns.NAME;
     Cursor c = cr.query(uri,projection,selection,selectionArgs,sortorder);
     if(c.moveToFirst()){
          for(int i=0;i<c.getCount();i++){
               c.moveToPosition(i);
               int idx = c.getColumnIndexOrThrow(PeopleColumns.NAME);
               Log.i("Test", c.getSting(idx));
          }
     }
}
</pre>


<p>如果要在应用中添加一个联系人..</p>

<pre lang="java">
private void insert(){
    ContentResolver cr = getContentResolver();
    ContentValues values = new ContentValues();
    Uri uri = Contacts.People.CONTENT_URI;
    values.put(People.NAME, "wxm");
    values.put(People.NOTES,"asd");
    cr.insert(uri, values);
}
</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/oct/blog/2011/06/27/SQLite%E7%B1%BB%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B./">SQLite类应用实例.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-27T04:51:00+08:00" pubdate data-updated="true">Jun 27<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><pre lang="java">
package com.amaker.test;

import android.content.ContentValues;
import android.content.Context;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteOpenHelper;

//数据库帮助类.
public class DBHelper extends SQLiteOpenHelper{
    //数据库名称
    private static final String DB_NAME = "coll.db";
    //表名称
    private static final String TBL_NAME = "CollTbl";
    private static final String CREATE_TBL = "create table "
           + " CollTbl(_id integer primary key autoincrement,"
           + "name text,"
           + "url text"
           + "desc text)";
    private SQLiteDatabase db;
    
    DBHelper(Context c){
        super(c, DB_NAME, null, 2);
    }
    @Override
    public void onCreate(SQLiteDatabase db){
        this.db = db;
        db.execSQL(CREATE_TABLE);
    }
    public void insert(ContentValues values){
        SQLiteDatabase db = getWritableDatabase();
        db.insert(TBL_NAME, null, values);
        db.close();
    }
    public Cursor query(){
        SQLiteDatabase db = getWritableDatabase();
        Cursor c = db.query(TBL_NAME, null, null, null, null, null, null);
        return c;
    }
    public void del(int id){
        if(db == null){
            db = getWritableDatabase();
        }
        db.delete(TBL_NAME,"_id=?", new String[]{String.valueOf(id)});
    }
    public void close(){
        if(db!=null){
              db.close();
        }
    }
    @Override
    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion){
     }
}
</pre>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/oct/blog/page/10/">&larr; Older</a>
    
    <a href="/oct/blog/archives">Blog Archives</a>
    
    <a class="next" href="/oct/blog/page/8/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/oct/blog/2012/06/11/emacs+auto-complete+plugins/">emacs auto-complete plugins</a>
      </li>
    
      <li class="post">
        <a href="/oct/blog/2012/06/09/LaTex+CJK+%E5%AD%97%E4%BD%93%E9%97%AE%E9%A2%98%5BLinux%5D/">LaTex CJK 字体问题[Linux]</a>
      </li>
    
      <li class="post">
        <a href="/oct/blog/2012/06/08/nmap+%E4%BD%BF%E7%94%A8./">nmap 使用.</a>
      </li>
    
      <li class="post">
        <a href="/oct/blog/2012/06/07/Arch+PGP+xxx+unknown+%E8%A7%A3%E5%86%B3/">Arch PGP xxx unknown 解决</a>
      </li>
    
      <li class="post">
        <a href="/oct/blog/2012/06/04/Mongo+%E8%81%9A%E5%90%88/">Mongo 聚合</a>
      </li>
    
  </ul>
</section>





<section>
 <h1>Categories</h1>
 <ul id="categories">
 <li class='category'><a href='/oct/blog/categories/android开发/'>Android开发 (16)</a></li>
<li class='category'><a href='/oct/blog/categories/apache/'>Apache (6)</a></li>
<li class='category'><a href='/oct/blog/categories/django/'>Django (3)</a></li>
<li class='category'><a href='/oct/blog/categories/linux/'>Linux (38)</a></li>
<li class='category'><a href='/oct/blog/categories/lisp/'>Lisp (1)</a></li>
<li class='category'><a href='/oct/blog/categories/mapx开发/'>MapX开发 (3)</a></li>
<li class='category'><a href='/oct/blog/categories/mongo/'>Mongo (2)</a></li>
<li class='category'><a href='/oct/blog/categories/moose::manual::attributes/'>Moose::Manual::Attributes (1)</a></li>
<li class='category'><a href='/oct/blog/categories/moose::manual::classes/'>Moose::Manual::Classes (1)</a></li>
<li class='category'><a href='/oct/blog/categories/moose::manual::concepts/'>Moose::Manual::Concepts (1)</a></li>
<li class='category'><a href='/oct/blog/categories/mysql/'>MySQL (3)</a></li>
<li class='category'><a href='/oct/blog/categories/nginx/'>Nginx (2)</a></li>
<li class='category'><a href='/oct/blog/categories/php/'>PHP (30)</a></li>
<li class='category'><a href='/oct/blog/categories/perl/'>Perl (32)</a></li>
<li class='category'><a href='/oct/blog/categories/perldoc/'>PerlDoc (1)</a></li>
<li class='category'><a href='/oct/blog/categories/python/'>Python (42)</a></li>
<li class='category'><a href='/oct/blog/categories/wordpress/'>WordPress (1)</a></li>
<li class='category'><a href='/oct/blog/categories/keepalive/'>keepalive (1)</a></li>
<li class='category'><a href='/oct/blog/categories/linux查看系统状态/'>linux查看系统状态 (1)</a></li>
<li class='category'><a href='/oct/blog/categories/lisp/'>lisp (1)</a></li>
<li class='category'><a href='/oct/blog/categories/make/'>make (1)</a></li>
<li class='category'><a href='/oct/blog/categories/man高亮/'>man高亮 (1)</a></li>
<li class='category'><a href='/oct/blog/categories/moose/'>moose (1)</a></li>
<li class='category'><a href='/oct/blog/categories/pdf/'>pdf (1)</a></li>
<li class='category'><a href='/oct/blog/categories/perlpod/'>perlpod (1)</a></li>
<li class='category'><a href='/oct/blog/categories/pkill/'>pkill (1)</a></li>
<li class='category'><a href='/oct/blog/categories/server/'>server (1)</a></li>
<li class='category'><a href='/oct/blog/categories/skills/'>skills (1)</a></li>
<li class='category'><a href='/oct/blog/categories/sql/'>sql (1)</a></li>
<li class='category'><a href='/oct/blog/categories/ssh/'>ssh (2)</a></li>
<li class='category'><a href='/oct/blog/categories/svn/'>svn (1)</a></li>
<li class='category'><a href='/oct/blog/categories/ubuntu/'>ubuntu (2)</a></li>
<li class='category'><a href='/oct/blog/categories/wp摘要/'>wp摘要 (1)</a></li>
<li class='category'><a href='/oct/blog/categories/wp页面模版/'>wp页面模版 (1)</a></li>
<li class='category'><a href='/oct/blog/categories/乱七八糟/'>乱七八糟 (24)</a></li>
<li class='category'><a href='/oct/blog/categories/前端技术/'>前端技术 (8)</a></li>
<li class='category'><a href='/oct/blog/categories/回归/'>回归 (1)</a></li>
<li class='category'><a href='/oct/blog/categories/设计模式/'>设计模式 (1)</a></li>
<li class='category'><a href='/oct/blog/categories/集体智慧/'>集体智慧 (7)</a></li>

 </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - wangxiaomo -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
